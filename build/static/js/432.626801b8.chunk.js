"use strict";(self.webpackChunkhey_dj=self.webpackChunkhey_dj||[]).push([[432],{4432:(e,n,r)=>{r.r(n),r.d(n,{default:()=>f});var s=r(2791),t=r(9241),i=r(7689),o=r(7022),a=r(9140),c=r(3360),d=r(2469),l=r(9942),g=r(5055),v=r(5178),u=r(1292),h=r(184);const f=()=>{const e=(0,s.useRef)(null),n=(0,s.useRef)(null),r=(0,i.s0)(),{user:f,clearUserContext:m}=(0,s.useContext)(u.ZP),[j,x]=(0,s.useState)(null),[y,w]=(0,s.useState)(null),[p,I]=(0,s.useState)(!0),[R,U]=(0,s.useState)(!1),C=async e=>{console.log("QR Code scanned:",e),console.log("Current user context:",f),I(!1),U(!0);try{if(e.startsWith("http")){console.log("Processing new format QR code (URL)");const n=new URL(e),s=n.searchParams.get("eventId"),t=n.searchParams.get("djId");if(console.log("Extracted eventId:",s,"djId:",t),s&&t){if(!f||!f._id)return console.log("User is not logged in, redirecting to registration"),m(),sessionStorage.setItem("pendingEventData",JSON.stringify({eventId:s,djId:t})),void(window.location.href=e);console.log("User is logged in, checking if already registered");try{const e=(await(0,l.U2)("/events/live")).find((e=>e._id===s));if(e){if(e.registeredUsers.some((e=>e.userId===f._id)))return console.log("User is already registered for this event"),void r("/genre-selection")}return console.log("User not registered for this event, assigning now"),await(0,l.v_)("/events/assign-user",{eventId:s,userId:f._id,djId:t}),void r("/genre-selection")}catch(y){return console.error("Error assigning user to event:",y),w((0,g.z)(y,"Failed to assign to event")),void U(!1)}}}console.log("Processing old format QR code (user ID)");try{const n=await(0,l.U2)("/user/dj-info/"+e);if(console.log("DJ info response:",n),!n.djName)return f&&f._id,w("This QR code is not recognized. Please contact the event organizer."),void U(!1);if(!f||!f._id){console.log("User is not logged in, redirecting to registration with DJ ID"),m();const n=`${window.location.origin}/register?djId=${e}`;return sessionStorage.setItem("pendingEventData",JSON.stringify({djId:e})),void(window.location.href=n)}console.log("User is logged in, finding live event");try{const n=(await(0,l.U2)("/events/live")).filter((n=>n.userId===e));if(n.length>0){const s=n[0];return s.registeredUsers.some((e=>e.userId===f._id))?(console.log("User is already registered for this event"),void r("/genre-selection")):(console.log("User not registered for this event, assigning now"),await(0,l.v_)("/events/assign-user",{eventId:s._id||s.eventId,userId:f._id,djId:e}),void r("/genre-selection"))}return w("No live events found for this DJ"),void U(!1)}catch(y){return console.error("Error finding live event:",y),w((0,g.z)(y,"Failed to find live event")),void U(!1)}}catch(n){return console.error("Error checking DJ info:",n),f&&f._id?(w("Unable to verify QR code. Please contact the event organizer."),void U(!1)):(w("Unable to verify QR code. Please contact the event organizer."),void U(!1))}}catch(y){console.error("Error in QR code processing:",y),w((0,g.z)(y,"Failed to process QR code scan"))}finally{U(!1)}};(0,s.useEffect)((()=>{let n=null;if(e.current&&p){n=new t.wF("qr-reader",{fps:10,qrbox:250},!1);const e=async e=>{await C(e)};n.render(e,(e=>{const n="string"===typeof e?e:(null===e||void 0===e?void 0:e.message)||"";"NotFoundException"===(e&&e.name?e.name:"")||n.includes("NotFoundException")||(n.includes("Camera access")?w("Camera access was denied. Please allow camera permissions and try again."):console.warn("QR Code scanning warning:",e))}))}return()=>{n&&n.clear().catch((e=>w((0,g.z)(e,"Failed to clear QR Scanner"))))}}),[p,f,r,m]);const N=()=>{x(null),w(null),I(!0)};return(0,h.jsx)(o.Z,{className:"mt-4",children:(0,h.jsxs)(a.Z,{className:"shadow",children:[(0,h.jsx)(a.Z.Header,{className:"bg-primary text-white",children:(0,h.jsx)("h2",{className:"mb-0",children:"Scan DJ's QR Code"})}),(0,h.jsx)(a.Z.Body,{children:p?(0,h.jsxs)("div",{children:[(0,h.jsx)("div",{id:"qr-reader",ref:e}),(0,h.jsxs)("div",{className:"text-center mt-3",children:[(0,h.jsx)("input",{ref:n,type:"file",accept:"image/*",onChange:async e=>{const r=e.target.files&&e.target.files[0];if(r){w(null),U(!0);try{const e="qr-file-reader";let n=document.getElementById(e);n||(n=document.createElement("div"),n.id=e,n.style.display="none",document.body.appendChild(n));const i=new t.t2(e),o=await i.scanFile(r,!0);await C(o);try{await i.clear()}catch(s){}}catch(i){console.error("File upload scan error:",i);((null===i||void 0===i?void 0:i.message)||String(i)).includes("NotFound")?w("Could not detect a QR code in the selected image. Please try a clearer image."):w((0,g.z)(i,"Failed to scan QR image"))}finally{U(!1),n.current&&(n.current.value="")}}},style:{display:"none"}}),(0,h.jsx)(c.Z,{variant:"secondary",onClick:()=>{var e;return null===(e=n.current)||void 0===e?void 0:e.click()},children:"Or upload a QR image"})]})]}):(0,h.jsx)("div",{className:"text-center",children:R?(0,h.jsx)(v.Z,{size:40,variant:"bootstrap"}):y?(0,h.jsxs)(d.Z,{variant:"danger",children:[y,(0,h.jsx)(c.Z,{variant:"primary",className:"mt-3",onClick:N,children:"Scan Again"})]}):j?(0,h.jsxs)("div",{children:[(0,h.jsxs)(d.Z,{variant:"success",children:[(0,h.jsx)("h4",{children:j.message}),(0,h.jsx)("hr",{}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Event:"})," ",j.eventName]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Location:"})," ",j.eventLocation]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Date:"})," ",new Date(j.eventDate).toLocaleString()]})]}),(0,h.jsx)(c.Z,{variant:"primary",onClick:N,children:"Scan Another Code"})]}):null})})]})})}}}]);
//# sourceMappingURL=432.626801b8.chunk.js.map