"use strict";(self.webpackChunkhey_dj=self.webpackChunkhey_dj||[]).push([[884],{9884:(e,n,s)=>{s.r(n),s.d(n,{default:()=>v});var t=s(2791),o=s(7689),a=s(9788),r=s(1292),l=s(9942),i=s(5055),c=s(5178),d=s(7022),g=s(2469),u=s(9140),m=s(3360),h=s(3855),p=s(184);const x=["Oriental","Hip-hop","Latin","Trance","Techno","Israeli","80s"],v=()=>{const{setGenre:e}=(0,t.useContext)(a.Z),{user:n,updateUser:s,loading:v,refreshAuth:S}=(0,t.useContext)(r.ZP),j=(0,o.s0)(),f=(0,o.TH)(),[G,P]=(0,t.useState)(""),[N,b]=(0,t.useState)(!1),[y,I]=(0,t.useState)(null),[Z,C]=(0,t.useState)(null);(0,t.useEffect)((()=>{console.log("GenreSelectionPage: useEffect triggered"),console.log("GenreSelectionPage: Current user context:",n),console.log("GenreSelectionPage: User loading state:",v),console.log("GenreSelectionPage: Current location:",f);const e=new URLSearchParams(f.search).get("eventId");console.log("GenreSelectionPage: eventId from URL params:",e);const s=sessionStorage.getItem("pendingEventData");console.log("GenreSelectionPage: pendingEventData from sessionStorage:",s);let t=null;if(s)try{t=JSON.parse(s).eventId,console.log("GenreSelectionPage: eventId from sessionStorage:",t)}catch(y){console.error("GenreSelectionPage: Error parsing pending event data:",y)}const o=e||t;o?(C(o),console.log("GenreSelectionPage: Event ID set from QR scan:",o)):console.log("GenreSelectionPage: No event ID found, user may not be in event context")}),[f,n,v]);const k=async t=>{console.log("GenreSelectionPage: handleGenreSelection called with genre:",t),console.log("GenreSelectionPage: Current user:",n),console.log("GenreSelectionPage: Current eventId:",Z),b(!0),I(null),e(t);try{if(!n||!n._id)return console.error("GenreSelectionPage: User not authenticated"),I("User not authenticated. Please log in again."),void b(!1);if(console.log("GenreSelectionPage: User authenticated, proceeding with genre selection"),Z)try{const e=sessionStorage.getItem("pendingEventData");let s;if(e)try{const n=JSON.parse(e);s=null===n||void 0===n?void 0:n.djId}catch(o){}console.log("GenreSelectionPage: Ensuring registration for eventId:",Z,"djId:",s),await(0,l.v_)("/events/assign-user",{eventId:Z,userId:n._id,...s?{djId:s}:{}}),console.log("GenreSelectionPage: Assignment ensured (or already registered).")}catch(a){const e=a&&a.response&&a.response.data&&a.response.data.message||"";"string"===typeof e&&e.toLowerCase().includes("already registered")?console.log("GenreSelectionPage: User already registered for event, continuing."):console.warn("GenreSelectionPage: Assignment preflight failed (continuing to genre update anyway):",a)}const e=await(0,l.v_)("/user/update-genre",{genre:t,youtubeLink:G});if(console.log("GenreSelectionPage: Genre update response:",e),e.user){if(s(e.user),(0,i.D)(e.message),Z){console.log("GenreSelectionPage: Updating event genre stats for eventId:",Z);try{await(0,l.v_)(`/events/${Z}/genre-select`,{genreChoice:t,youtubeLink:G}),console.log("GenreSelectionPage: Event genre stats updated successfully")}catch(r){console.error("GenreSelectionPage: Error updating event genre stats:",r)}}else console.log("GenreSelectionPage: No eventId, skipping event genre stats update");if(Boolean(e.profileCompleted||e.user&&(e.user.phoneNumber||e.user.gender)||e.user&&!0===e.user.isProfileComplete)){const e=sessionStorage.getItem("pendingEventData");let n;if(e)try{const s=JSON.parse(e);n=null===s||void 0===s?void 0:s.djId}catch(o){}const s=Z?`?eventId=${Z}${n?`&djId=${n}`:""}`:"";console.log("GenreSelectionPage: Navigating to /confirmation"+s),j("/confirmation"+s)}else console.log("GenreSelectionPage: Profile not completed, navigating to /complete-profile"),j("/complete-profile")}}catch(y){console.error("GenreSelectionPage: Error in handleGenreSelection:",y);const n=(0,i.z)(y);I(n)}finally{b(!1)}};return(0,p.jsxs)(d.Z,{className:"mt-4 mb-5 pb-5",children:[(0,p.jsxs)("div",{className:"text-center mb-4",children:[(0,p.jsx)("h1",{children:"Select Your Genre"}),(0,p.jsx)("p",{className:"lead",children:"What music would you like to listen to or share?"})]}),y&&(0,p.jsxs)(g.Z,{variant:"danger",className:"mb-4",children:[(0,p.jsx)("i",{className:"bi bi-exclamation-triangle-fill me-2"}),y]}),v?(0,p.jsxs)("div",{className:"text-center",children:[(0,p.jsx)(c.Z,{size:40,variant:"bootstrap"}),(0,p.jsx)("p",{className:"mt-3",children:"Loading user information..."})]}):n?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("div",{className:"row g-4 mb-4",children:x.map(((e,n)=>(0,p.jsx)("div",{className:"col-sm-12 col-md-6 col-lg-4",children:(0,p.jsx)(u.Z,{className:"h-100",children:(0,p.jsxs)(u.Z.Body,{className:"d-flex flex-column",children:[(0,p.jsx)(u.Z.Title,{className:"text-center",children:e}),(0,p.jsx)(m.Z,{variant:"primary",className:"mt-auto",onClick:()=>k(e),disabled:N,children:N?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(c.Z,{size:20,variant:"bootstrap"}),(0,p.jsx)("span",{className:"ms-2",children:"Selecting..."})]}):"Select"})]})})},n)))}),(0,p.jsx)(u.Z,{className:"mt-4",children:(0,p.jsxs)(u.Z.Body,{children:[(0,p.jsx)(u.Z.Title,{children:"Custom Genre and YouTube Link"}),(0,p.jsxs)(h.Z.Group,{className:"mb-3",children:[(0,p.jsx)(h.Z.Label,{children:"YouTube Link"}),(0,p.jsx)(h.Z.Control,{type:"text",placeholder:"Paste a YouTube link here",value:G,onChange:e=>P(e.target.value)})]}),(0,p.jsx)(m.Z,{variant:"success",onClick:()=>k("Custom"),disabled:N,className:"w-100",children:N?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(c.Z,{size:20,variant:"bootstrap"}),(0,p.jsx)("span",{className:"ms-2",children:"Submitting..."})]}):"Submit Custom Genre and Link"})]})})]}):(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)(g.Z,{variant:"warning",className:"mb-4",children:[(0,p.jsx)("i",{className:"bi bi-exclamation-triangle-fill me-2"}),"User not authenticated. Please wait or refresh the page."]}),(0,p.jsx)(u.Z,{className:"mb-4",children:(0,p.jsxs)(u.Z.Body,{children:[(0,p.jsx)(u.Z.Title,{children:"Debug Information"}),(0,p.jsxs)("div",{className:"mb-3",children:[(0,p.jsx)("strong",{children:"Token in localStorage:"})," ",localStorage.getItem("token")?"Token exists":"No token"]}),(0,p.jsxs)("div",{className:"mb-3",children:[(0,p.jsx)("strong",{children:"User Context State:"})," ",JSON.stringify({user:n,loading:v})]}),(0,p.jsx)(m.Z,{variant:"info",onClick:S,className:"me-2",children:"Refresh Authentication"}),(0,p.jsx)(m.Z,{variant:"secondary",onClick:()=>window.location.reload(),children:"Reload Page"})]})})]})]})}}}]);
//# sourceMappingURL=884.c2fedfa6.chunk.js.map